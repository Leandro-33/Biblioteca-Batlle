<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Bibliotecas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-size: 13px;
        }

        /* LOGIN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            width: 100%;
            max-width: 450px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 40px;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .error-msg {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }

        /* MAIN APP */
        .app-container {
            display: none;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 22px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }

        .user-menu-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            font-weight: 600;
        }

        .user-menu-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .user-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 280px;
            display: none;
            z-index: 1000;
            animation: dropDown 0.3s;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes dropDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:first-child {
            border-radius: 10px 10px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 10px 10px;
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item.danger {
            color: #e74c3c;
        }

        .dropdown-item.danger:hover {
            background: #fee;
        }

        .dropdown-separator {
            height: 1px;
            background: #e0e0e0;
            margin: 5px 0;
        }

        .dropdown-header {
            padding: 10px 20px;
            font-weight: 700;
            color: #667eea;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
        }

        .content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            background: #faf6f0;
        }

        .panel {
            background: #faf6f0;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            display: none;
            animation: fadeIn 0.5s;
            height: 100%;
            flex-direction: column;
        }

        .panel.active {
            display: flex;
        }

        .panel h2 {
            color: #667eea;
            margin: 0;
            padding: 20px 30px 10px 30px;
            font-size: 20px;
            font-weight: 700;
            background: #faf6f0;
        }

        /* FORMULARIOS */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.row-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-row.row-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-row.row-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            padding: 15px 30px 10px 30px;
            flex-wrap: wrap;
            background: #faf6f0;
        }

        /* TABLA */
        .table-container {
            background: white;
            padding: 0 30px 30px 30px;
            border-radius: 0;
            box-shadow: none;
            overflow-x: auto;
            margin-top: 0;
            max-height: calc(100% - 100px);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
            transition: background 0.3s;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .search-bar {
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            background: transparent;
            padding: 10px 0;
            border-radius: 0;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
        }

        .search-bar input {
            flex: 1;
            min-width: 180px;
        }

        table {
            width: auto;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
            flex: 1;
        }

        th, td {
            padding: 3px 4px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            white-space: normal;
            word-wrap: break-word;
        }

        th {
            background: linear-gradient(135deg, #d4936e 0%, #c67c5c 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-width: 100px;
            cursor: default;
        }

        th:nth-child(1), th:nth-child(2), th:nth-child(6), th:nth-child(7), th:nth-child(8), th:nth-child(9), th:nth-child(11) {
            white-space: nowrap;
        }

        tbody tr:hover {
            background: #f5ede5;
            box-shadow: inset 0 0 10px rgba(212, 147, 110, 0.1);
        }

        tbody tr {
            transition: all 0.2s;
        }

        .action-btns {
            display: flex;
            gap: 4px;
            justify-content: flex-start;
            flex-wrap: wrap;
            min-width: 140px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 11px;
            white-space: nowrap;
        }

        /* Columnas espec√≠ficas con tama√±os m√≠nimos */
        td:nth-child(1) { width: 30px; white-space: nowrap; } /* Ordinal */
        td:nth-child(2) { width: 40px; white-space: nowrap; } /* Estante */
        td:nth-child(3) { width: 55px; } /* Apellido */
        td:nth-child(4) { width: 55px; } /* Nombre */
        td:nth-child(5) { width: 95px; } /* T√≠tulo */
        td:nth-child(6) { width: 35px; white-space: nowrap; } /* Volumen */
        td:nth-child(7) { width: 30px; white-space: nowrap; } /* Tomo */
        td:nth-child(8) { width: 35px; white-space: nowrap; } /* A√±o */
        td:nth-child(9) { width: 50px; white-space: nowrap; } /* Encuadernado */
        td:nth-child(10) { width: 70px; } /* Observaciones */
        td:nth-child(11) { width: 40px; white-space: nowrap; } /* Ejemplares */
        td:nth-child(12) { width: 55px; } /* Estado */
        td:nth-child(13) { width: 65px; } /* ISBN */
        td:nth-child(14) { width: 75px; } /* Acciones */

        /* Tooltip para textos largos */
        td[title] {
            cursor: help;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Mejoras de responsividad para pantallas peque√±as */
        @media (max-width: 1200px) {
            .table-container {
                padding: 15px;
            }
            
            th, td {
                padding: 8px 5px;
                font-size: 11px;
            }
            
            .search-bar {
                gap: 5px;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 10px;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .table-container {
                padding: 10px;
                max-height: 60vh;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .search-bar input {
                min-width: 100%;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 10px;
            }
            
            /* Ocultar columnas menos importantes en m√≥vil */
            td:nth-child(9), th:nth-child(9) { display: none; } /* Encuadernado */
            td:nth-child(10), th:nth-child(10) { display: none; } /* Observaciones */
            td:nth-child(13), th:nth-child(13) { display: none; } /* ISBN */
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 40px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .stat-card p {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 500;
        }

        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* CHECKLIST BALANCE */
        .balance-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .estante-selector {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .checklist-container {
            max-height: 600px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .checklist-book-item {
            background: white;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
        }

        .checklist-book-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .checklist-book-item.found {
            background: #d4edda;
            border-color: #28a745;
        }

        .checklist-book-item.missing {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .book-info {
            flex: 1;
        }

        .book-info h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .book-info p {
            color: #666;
            font-size: 13px;
            margin: 2px 0;
        }

        .book-actions {
            display: flex;
            gap: 10px;
        }

        .balance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .summary-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .summary-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .summary-card h3 {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .summary-card p {
            font-size: 14px;
            opacity: 0.95;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #27ae60;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .badge-disponible {
            background: #d4edda;
            color: #155724;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-prestado {
            background: #fff3cd;
            color: #856404;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-donado {
            background: #d1ecf1;
            color: #0c5460;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* PANEL DE ESTANTE */
        .estante-panel {
            position: fixed;
            right: -400px;
            top: 70px;
            width: 400px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            z-index: 900;
            display: flex;
            flex-direction: column;
        }

        .estante-panel.active {
            right: 0;
        }

        .estante-panel-header {
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .estante-panel-header h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
        }

        .estante-search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            color: #333;
        }

        .estante-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .estante-book-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .estante-book-item:hover {
            background: #e8eaf6;
            transform: translateX(5px);
            border-left-color: #764ba2;
        }

        .estante-book-item h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 13px;
            font-weight: 600;
        }

        .estante-book-item p {
            margin: 2px 0;
            color: #666;
            font-size: 11px;
        }

        .estante-book-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .estante-panel-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .estante-panel-close:hover {
            background: rgba(255,255,255,0.4);
        }

        .estante-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .estante-stat {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .estante-stat-number {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .estante-stat-label {
            color: #666;
            font-size: 11px;
            margin-top: 3px;
        }

        .estante-empty {
            text-align: center;
            padding: 30px 20px;
            color: #999;
        }

        .estante-empty p {
            margin: 0;
            font-size: 13px;
        }

        @media (max-width: 1024px) {
            .estante-panel {
                width: 350px;
                right: -350px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
            }
            .estante-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h2>üìö Sistema de Biblioteca de Batlle</h2>
           
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-login">Ingresar</button>
                <div class="error-msg" id="loginError"></div>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <h1>üìö Sistema de Gesti√≥n de Bibliotecas</h1>
            <div class="user-info">
                <div class="sync-indicator">
                    <div class="sync-dot"></div>
                    <span>Sincronizado</span>
                    <span id="lastSyncTime" style="font-size: 11px; color: #666; margin-left: 10px;"></span>
                </div>
                <div class="user-menu-trigger" onclick="toggleUserMenu()">
                    <span>üë§</span>
                    <span id="currentUser"></span>
                    <span>‚ñº</span>
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-item" onclick="showPanel('libros')">
                        <span>üìñ</span> Gesti√≥n de Libros
                    </div>
                    
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-header">üë• Gesti√≥n de Usuarios</div>
                    <div class="dropdown-item" onclick="showPanel('usuarios-activos')">
                        <span>‚úì</span> Usuarios Activos
                    </div>
                    <div class="dropdown-item" onclick="showPanel('nuevo-usuario')">
                        <span>‚ûï</span> Nuevo Usuario
                    </div>
                    <div class="dropdown-item" onclick="showPanel('roles')">
                        <span>üé≠</span> Roles
                    </div>
                    <div class="dropdown-item" onclick="showPanel('eliminar-usuarios')">
                        <span>üóëÔ∏è</span> Eliminar Usuarios
                    </div>
                    
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-header">üìÑ Informes</div>
                    <div class="dropdown-item" onclick="showPanel('reporte-estantes')">
                        <span>üìö</span> Reporte por Estantes
                    </div>
                    <div class="dropdown-item" onclick="showPanel('libros-disponibles')">
                        <span>‚úÖ</span> Disponibles
                    </div>
                    <div class="dropdown-item" onclick="showPanel('libros-prestados')">
                        <span>üì§</span> Prestados
                    </div>
                    <div class="dropdown-item" onclick="showPanel('libros-donados')">
                        <span>üéÅ</span> Donados
                    </div>
                    <div class="dropdown-item" onclick="showPanel('libros-repetidos')">
                        <span>üìë</span> Repetidos
                    </div>
                    
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-header">‚öñÔ∏è Balance</div>
                    <div class="dropdown-item" onclick="showPanel('control-avance')">
                        <span>üìà</span> Control de Avance
                    </div>
                    <div class="dropdown-item" onclick="showPanel('reiniciar-balance')">
                        <span>üîÑ</span> Reiniciar
                    </div>
                    <div class="dropdown-item" onclick="showPanel('informe-faltante')">
                        <span>‚ùå</span> Informe Faltante
                    </div>
                    
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="showPanel('mi-perfil')">
                        <span>üë§</span> Mi Perfil
                    </div>
                    <div class="dropdown-item" onclick="showPanel('configuracion')">
                        <span>‚öôÔ∏è</span> Configuraci√≥n
                    </div>
                    <div class="dropdown-item danger" onclick="logout()">
                        <span>üö™</span> Cerrar Sesi√≥n
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="content">
                <!-- GESTI√ìN DE LIBROS (P√ÅGINA PRINCIPAL) -->
                <div class="panel active" id="panel-libros">
                    <h2>Gesti√≥n de Libros</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="openAddBookModal()">‚ûï Agregar Libro</button>
                        <button class="btn btn-info" onclick="document.getElementById('importFile').click()">üì• Importar Excel</button>
                        <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar Excel</button>
                        <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none" onchange="importFromExcel(event)">
                    </div>
                    
                    <div class="table-container">
                        <div class="search-bar">
                            <input type="text" id="searchInput" placeholder="üîç Buscar por t√≠tulo, autor, ISBN, estante...">
                            <input type="text" id="filterEstante" placeholder="üìö Filtrar por estante (ej: A1, B2...)" style="min-width: 200px;">
                            <button class="btn btn-sm btn-warning" onclick="clearFilters()" style="white-space: nowrap;">üîÑ Limpiar</button>
                        </div>

                        <table id="booksTable">
                            <thead>
                                <tr>
                                    <th>Ordinal</th>
                                    <th>Estante</th>
                                    <th>Apellido</th>
                                    <th>Nombre</th>
                                    <th>T√≠tulo</th>
                                    <th>Volumen</th>
                                    <th>Tomo</th>
                                    <th>A√±o</th>
                                    <th>Encuadernado</th>
                                    <th>Observaciones</th>
                                    <th>Ejemplares</th>
                                    <th>Estado</th>
                                    <th>ISBN</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="booksTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- USUARIOS ACTIVOS -->
                <div class="panel" id="panel-usuarios-activos">
                    <h2>Usuarios Activos</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th>√öltima Actividad</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="activeUsersTable"></tbody>
                    </table>
                </div>

                <!-- NUEVO USUARIO -->
                <div class="panel" id="panel-nuevo-usuario">
                    <h2>Crear Nuevo Usuario</h2>
                    <form id="newUserForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Usuario</label>
                                <input type="text" id="newUsername" required>
                            </div>
                            <div class="form-group">
                                <label>Contrase√±a</label>
                                <input type="password" id="newPassword" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Rol</label>
                                <select id="newUserRole">
                                    <option value="admin">Administrador</option>
                                    <option value="bibliotecario">Bibliotecario</option>
                                    <option value="usuario">Usuario</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Crear Usuario</button>
                    </form>
                </div>

                <!-- CONTROL DE AVANCE BALANCE -->
                <div class="panel" id="panel-control-avance">
                    <h2>‚öñÔ∏è Sistema de Balance de Inventario</h2>
                    
                    <div class="balance-container">
                        <h3>Iniciar Nuevo Balance</h3>
                        <p style="color: #666; margin-bottom: 20px;">Seleccione un estante para comenzar la auditor√≠a f√≠sica del inventario.</p>
                        
                        <div class="estante-selector">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">Seleccionar Estante a Auditar:</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="balanceEstanteSelect" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <option value="">-- Seleccione un estante --</option>
                                </select>
                                <button class="btn btn-primary" onclick="startEstanteBalance()">üîç Iniciar Auditor√≠a</button>
                            </div>
                        </div>

                        <div id="balanceChecklistContainer" style="display: none;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 id="currentEstanteName" style="color: #667eea; margin-bottom: 15px;"></h3>
                                
                                <div class="balance-summary">
                                    <div class="summary-card">
                                        <h3 id="totalBooksBalance">0</h3>
                                        <p>Total de Libros</p>
                                    </div>
                                    <div class="summary-card success">
                                        <h3 id="foundBooksBalance">0</h3>
                                        <p>Encontrados ‚úì</p>
                                    </div>
                                    <div class="summary-card danger">
                                        <h3 id="missingBooksBalance">0</h3>
                                        <p>Faltantes ‚úó</p>
                                    </div>
                                    <div class="summary-card warning">
                                        <h3 id="pendingBooksBalance">0</h3>
                                        <p>Por Revisar</p>
                                    </div>
                                </div>

                                <div class="progress-bar">
                                    <div class="progress-fill" id="estanteProgress">0%</div>
                                </div>
                            </div>

                            <div class="checklist-container" id="balanceBooksList"></div>

                            <div class="btn-group" style="margin-top: 20px;">
                                <button class="btn btn-success" onclick="finishEstanteBalance()">üíæ Finalizar y Guardar Estante</button>
                                <button class="btn btn-warning" onclick="cancelEstanteBalance()">‚úñ Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <div class="balance-container" id="balanceProgressContainer" style="display: none;">
                        <h3>Progreso General del Balance</h3>
                        <div id="generalBalanceStats"></div>
                        <div id="estantesCompletedList"></div>
                        <div class="btn-group" style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="generateFinalBalanceReport()">üìÑ Generar Reporte Final</button>
                            <button class="btn btn-danger" onclick="resetBalance()">üîÑ Reiniciar Balance Completo</button>
                        </div>
                    </div>
                </div>

                <!-- REPORTE ESTANTES -->
                <div class="panel" id="panel-reporte-estantes">
                    <h2>Reporte por Estantes</h2>
                    <div class="form-row">
                        <select id="estanteSelect" onchange="loadEstanteReport()">
                            <option value="">Seleccionar estante</option>
                        </select>
                        <button class="btn btn-primary" onclick="printEstanteReport(false)">Imprimir Estante</button>
                        <button class="btn btn-success" onclick="printEstanteReport(true)">Imprimir General</button>
                    </div>
                    <div id="estanteReportContent"></div>
                </div>

                <!-- Otros paneles simplificados -->
                <div class="panel" id="panel-roles"><h2>Gesti√≥n de Roles</h2></div>
                <div class="panel" id="panel-eliminar-usuarios"><h2>Eliminar Usuarios</h2></div>
                <div class="panel" id="panel-libros-disponibles"><h2>Libros Disponibles</h2></div>
                <div class="panel" id="panel-libros-prestados"><h2>Libros Prestados</h2></div>
                <div class="panel" id="panel-libros-donados"><h2>Libros Donados</h2></div>
                <div class="panel" id="panel-libros-repetidos"><h2>Libros Repetidos</h2></div>
                <div class="panel" id="panel-reiniciar-balance"><h2>Reiniciar Balance</h2></div>
                <div class="panel" id="panel-informe-faltante"><h2>Informe de Faltantes</h2></div>
                <div class="panel" id="panel-mi-perfil"><h2>Mi Perfil</h2></div>
                <div class="panel" id="panel-configuracion"><h2>Configuraci√≥n</h2></div>
            </div>
        </div>
    </div>

    <!-- PANEL DE ESTANTE (LADO DERECHO) -->
    <div class="estante-panel" id="estantePanel">
        <div class="estante-panel-header">
            <button class="estante-panel-close" onclick="closeEstantePanel()">√ó</button>
            <h3 id="estantePanelTitle">Estante: --</h3>
            <input type="text" class="estante-search-input" id="estantePanelSearch" placeholder="üîç Buscar en estante...">
        </div>
        <div class="estante-panel-content">
            <div class="estante-stats">
                <div class="estante-stat">
                    <div class="estante-stat-number" id="estanteTotalBooks">0</div>
                    <div class="estante-stat-label">Total</div>
                </div>
                <div class="estante-stat">
                    <div class="estante-stat-number" id="estanteAvailableBooks">0</div>
                    <div class="estante-stat-label">Disponibles</div>
                </div>
            </div>
            <div id="estantePanelBooks"></div>
        </div>
    </div>

    <!-- MODAL AGREGAR/EDITAR LIBRO -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Agregar Libro</h2>
                <span class="modal-close" onclick="closeBookModal()">&times;</span>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                
                <div class="form-row row-2">
                    <div class="form-group">
                        <label>Estante *</label>
                        <input type="text" id="estante" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select id="estado" required>
                            <option value="disponible">Disponible</option>
                            <option value="prestado">Prestado</option>
                            <option value="donado">Donado</option>
                        </select>
                    </div>
                </div>

                <div class="form-row row-2">
                    <div class="form-group">
                        <label>Apellido *</label>
                        <input type="text" id="apellido" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="nombre" required>
                    </div>
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label>T√≠tulo *</label>
                        <input type="text" id="titulo" required>
                    </div>
                </div>

                <div class="form-row row-4">
                    <div class="form-group">
                        <label>Volumen</label>
                        <input type="text" id="volumen">
                    </div>
                    <div class="form-group">
                        <label>Tomo</label>
                        <input type="text" id="tomo">
                    </div>
                    <div class="form-group">
                        <label>A√±o</label>
                        <input type="text" id="anio" placeholder="Ej: 2020">
                        <div class="checkbox-group">
                            <input type="checkbox" id="noEspecificaYear" onchange="toggleYearInput()">
                            <label style="margin: 0;">No especifica</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ejemplares</label>
                        <input type="number" id="ejemplares" min="1" value="1">
                    </div>
                </div>

                <div class="form-row row-2">
                    <div class="form-group">
                        <label>Encuadernado</label>
                        <input type="text" id="encuadernado" placeholder="Ej: Tapa dura">
                    </div>
                    <div class="form-group">
                        <label>ISBN</label>
                        <input type="text" id="isbn">
                    </div>
                </div>

                <div class="form-row full-width">
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="observaciones" rows="3"></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                    <button type="button" class="btn btn-danger" onclick="closeBookModal()">‚úñ Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // DATOS EN MEMORIA (simulando sincronizaci√≥n en nube)
        let currentUser = null;
        let books = [];
        let users = [];
        let balanceData = {};
        let estantes = [];
        let lastState = {
            panel: 'libros',
            searchTerm: '',
            filterEstante: '',
            scrollPosition: 0
        };
        
        // Variables para optimizaci√≥n de b√∫squeda
        let searchTimeout = null;
        let filterTimeout = null;
        let cachedFilteredBooks = null;

        // STORAGE WRAPPER - Compatible con window.storage y fallback a sessionStorage
        const storage = {
            async get(key) {
                try {
                    if (window.storage) {
                        return await window.storage.get(key);
                    } else {
                        const value = sessionStorage.getItem(key);
                        return value ? { key, value } : null;
                    }
                } catch (e) {
                    const value = sessionStorage.getItem(key);
                    return value ? { key, value } : null;
                }
            },
            async set(key, value) {
                try {
                    if (window.storage) {
                        return await window.storage.set(key, value);
                    } else {
                        sessionStorage.setItem(key, value);
                        return { key, value };
                    }
                } catch (e) {
                    sessionStorage.setItem(key, value);
                    return { key, value };
                }
            }
        };

        // Guardar datos de sesi√≥n
        function saveSessionData() {
            if (currentUser) {
                try {
                    sessionStorage.setItem('biblioteca-session', JSON.stringify({
                        user: currentUser,
                        timestamp: new Date().toISOString()
                    }));
                } catch (e) {
                    console.warn('Error al guardar sesi√≥n:', e);
                }
            }
        }

        // INICIALIZACI√ìN
        async function init() {
            console.log('üöÄ Iniciando aplicaci√≥n...');
            await loadFromStorage();
            
            // Verificar si hay sesi√≥n activa guardada
            const savedSession = sessionStorage.getItem('biblioteca-session');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    currentUser = sessionData.user;
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    document.getElementById('currentUser').textContent = currentUser.username;
                    setupSearchListeners();
                    restoreLastState();
                    console.log('‚úÖ Sesi√≥n restaurada para:', currentUser.username);
                } catch (e) {
                    console.warn('Sesi√≥n corrupta, requiere nuevo login');
                    sessionStorage.removeItem('biblioteca-session');
                }
            }
            
            if (!users.length) {
                users = [
                    { username: 'admin', password: 'admin123', role: 'admin', lastActivity: new Date().toISOString(), active: true }
                ];
                await saveToStorage();
                console.log('‚úÖ Usuario admin creado:', users);
            } else {
                console.log('‚úÖ Usuarios cargados:', users);
            }
            
            // Auto-guardado cada 30 segundos
            setInterval(async () => {
                if (currentUser && books.length > 0) {
                    await saveToStorage();
                    console.log('üíæ Auto-guardado realizado -', new Date().toLocaleTimeString());
                }
            }, 30000);

            // Guardar estado al cambiar de pesta√±a o cerrar
            window.addEventListener('beforeunload', async () => {
                if (currentUser) {
                    await saveLastState();
                    await saveToStorage();
                }
            });

            // Guardar estado al hacer scroll
            const content = document.querySelector('.content');
            if (content) {
                let scrollTimeout;
                content.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        if (currentUser) {
                            lastState.scrollPosition = content.scrollTop;
                        }
                    }, 500);
                });
            }
            
            // Guardar sesi√≥n cada 10 segundos mientras est√© activa
            setInterval(() => {
                if (currentUser) {
                    saveSessionData();
                }
            }, 10000);
        }

        // STORAGE (Sincronizaci√≥n en nube o local)
        async function loadFromStorage() {
            try {
                const data = await storage.get('biblioteca-data');
                if (data && data.value) {
                    const parsed = JSON.parse(data.value);
                    books = parsed.books || [];
                    users = parsed.users || [];
                    balanceData = parsed.balanceData || {};
                    estantes = parsed.estantes || [];
                    lastState = parsed.lastState || {
                        panel: 'libros',
                        searchTerm: '',
                        filterEstante: '',
                        scrollPosition: 0
                    };
                    console.log('‚úÖ Datos cargados:', {
                        libros: books.length,
                        usuarios: users.length,
                        ultimoPanel: lastState.panel
                    });
                }
            } catch (e) {
                console.log('Iniciando con datos por defecto');
            }
        }

        async function saveToStorage() {
            try {
                const data = { books, users, balanceData, estantes, lastState };
                await storage.set('biblioteca-data', JSON.stringify(data));
                
                // Actualizar timestamp de sincronizaci√≥n
                const now = new Date();
                const timeString = now.toLocaleTimeString('es-ES');
                const syncEl = document.getElementById('lastSyncTime');
                if (syncEl) {
                    syncEl.textContent = `(${timeString})`;
                }
                
                console.log('‚úì Datos sincronizados -', timeString);
            } catch (e) {
                console.warn('Error al guardar:', e);
            }
        }

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('üîë Intentando login...');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            console.log('Usuario:', username, 'Usuarios disponibles:', users);
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                user.lastActivity = new Date().toISOString();
                await saveToStorage();
                
                // Guardar sesi√≥n en sessionStorage para persistencia
                saveSessionData();
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('currentUser').textContent = user.username;
                
                // Configurar listeners de b√∫squeda
                setupSearchListeners();
                
                // Restaurar √∫ltimo estado
                restoreLastState();
                
                console.log('‚úÖ Sesi√≥n iniciada para:', user.username);
            } else {
                document.getElementById('loginError').textContent = 'Usuario o contrase√±a incorrectos';
            }
        });

        // Restaurar √∫ltimo estado de la aplicaci√≥n
        function restoreLastState() {
            console.log('üîÑ Restaurando √∫ltimo estado:', lastState);
            
            // Cargar panel guardado
            showPanel(lastState.panel);
            
            // Si es el panel de libros, restaurar filtros
            if (lastState.panel === 'libros') {
                setTimeout(() => {
                    if (lastState.searchTerm) {
                        document.getElementById('searchInput').value = lastState.searchTerm;
                    }
                    if (lastState.filterEstante) {
                        document.getElementById('filterEstante').value = lastState.filterEstante;
                    }
                    
                    // Aplicar filtros si existen
                    if (lastState.searchTerm || lastState.filterEstante) {
                        applyFilters();
                    }
                    
                    // Restaurar posici√≥n de scroll
                    if (lastState.scrollPosition > 0) {
                        const content = document.querySelector('.content');
                        if (content) {
                            content.scrollTop = lastState.scrollPosition;
                        }
                    }
                }, 100);
            }
        }

        function logout() {
            currentUser = null;
            // Limpiar sesi√≥n
            sessionStorage.removeItem('biblioteca-session');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').textContent = '';
            console.log('üö™ Sesi√≥n cerrada');
        }

        // MEN√ö DESPLEGABLE USUARIO
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', (e) => {
            const userMenu = document.querySelector('.user-menu-trigger');
            const dropdown = document.getElementById('userDropdown');
            if (dropdown && !userMenu.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // NAVEGACI√ìN
        function showPanel(panelId) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            const panel = document.getElementById(`panel-${panelId}`);
            if (panel) {
                panel.classList.add('active');
            }
            
            // Cerrar men√∫ de usuario
            document.getElementById('userDropdown').classList.remove('show');
            
            // Guardar panel actual
            lastState.panel = panelId;
            saveLastState();
            
            if (panelId === 'libros') loadBooks();
            if (panelId === 'control-avance') loadBalanceProgress();
            if (panelId === 'reporte-estantes') loadEstanteSelect();
            
            // Actualizar dashboard si es necesario
            if (panelId === 'dashboard') loadDashboard();
        }

        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(`submenu-${menuId}`);
            if (submenu) submenu.classList.toggle('show');
        }

        // Guardar estado actual
        async function saveLastState() {
            // Guardar posici√≥n de scroll
            const content = document.querySelector('.content');
            if (content) {
                lastState.scrollPosition = content.scrollTop;
            }
            
            // No es necesario guardar despu√©s de cada b√∫squeda
            // Solo guardar peri√≥dicamente con auto-save
        }

        // Dashboard
        function loadDashboard() {
            const totalEl = document.getElementById('totalLibros');
            const dispEl = document.getElementById('disponibles');
            const prestEl = document.getElementById('prestados');
            const donEl = document.getElementById('donados');
            
            if (totalEl) totalEl.textContent = books.length;
            if (dispEl) dispEl.textContent = books.filter(b => b.estado === 'disponible').length;
            if (prestEl) prestEl.textContent = books.filter(b => b.estado === 'prestado').length;
            if (donEl) donEl.textContent = books.filter(b => b.estado === 'donado').length;
        }

        // GESTI√ìN DE LIBROS
        function openAddBookModal() {
            document.getElementById('modalTitle').textContent = 'Agregar Libro';
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('ejemplares').value = '1';
            document.getElementById('estado').value = 'disponible';
            document.getElementById('noEspecificaYear').checked = false;
            document.getElementById('anio').disabled = false;
            document.getElementById('bookModal').classList.add('show');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('show');
            document.getElementById('bookForm').reset();
            
            // Actualizar panel de estante si est√° abierto
            const currentEstante = document.getElementById('filterEstante').value;
            if (currentEstante && document.getElementById('estantePanel').classList.contains('active')) {
                updateEstantePanelBooks(currentEstante);
            }
        }

        function toggleYearInput() {
            const checkbox = document.getElementById('noEspecificaYear');
            const yearInput = document.getElementById('anio');
            yearInput.disabled = checkbox.checked;
            if (checkbox.checked) yearInput.value = '';
        }

        // Calcular siguiente ordinal
        function getNextOrdinal() {
            if (books.length === 0) return 1;
            const ordinales = books
                .map(b => parseInt(b.ordinal) || 0)
                .filter(n => !isNaN(n));
            return ordinales.length > 0 ? Math.max(...ordinales) + 1 : 1;
        }

        document.getElementById('bookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('bookId').value;
            const noEspecificaYear = document.getElementById('noEspecificaYear').checked;
            
            const book = {
                id: id || Date.now().toString(),
                ordinal: id ? books.find(b => b.id === id).ordinal : getNextOrdinal().toString(),
                estante: document.getElementById('estante').value,
                apellido: document.getElementById('apellido').value,
                nombre: document.getElementById('nombre').value,
                titulo: document.getElementById('titulo').value,
                volumen: document.getElementById('volumen').value,
                tomo: document.getElementById('tomo').value,
                anio: noEspecificaYear ? 'No especifica' : document.getElementById('anio').value,
                encuadernado: document.getElementById('encuadernado').value,
                observaciones: document.getElementById('observaciones').value,
                ejemplares: document.getElementById('ejemplares').value || '1',
                estado: document.getElementById('estado').value,
                isbn: document.getElementById('isbn').value
            };

            if (id) {
                const index = books.findIndex(b => b.id === id);
                books[index] = book;
            } else {
                books.push(book);
                if (book.estante && !estantes.includes(book.estante)) {
                    estantes.push(book.estante);
                }
            }

            await saveToStorage();
            closeBookModal();
            // Limpiar filtros y volver al inicio
            clearFilters();
            loadDashboard();
        });

        function loadBooks() {
            const tbody = document.getElementById('booksTableBody');
            
            // Actualizar selector de estantes
            updateFilterEstante();
            
            // Mostrar indicador de carga si hay muchos libros
            if (books.length > 100) {
                tbody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 20px;">‚è≥ Cargando libros...</td></tr>';
            }
            
            // Usar requestAnimationFrame para no bloquear la UI
            requestAnimationFrame(() => {
                const html = books.map(book => `
                    <tr>
                        <td title="${book.ordinal || ''}">${book.ordinal || ''}</td>
                        <td title="${book.estante || ''}">${book.estante || ''}</td>
                        <td title="${book.apellido || ''}">${book.apellido || ''}</td>
                        <td title="${book.nombre || ''}">${book.nombre || ''}</td>
                        <td title="${book.titulo || ''}">${book.titulo || ''}</td>
                        <td title="${book.volumen || ''}">${book.volumen || ''}</td>
                        <td title="${book.tomo || ''}">${book.tomo || ''}</td>
                        <td title="${book.anio || ''}">${book.anio || ''}</td>
                        <td title="${book.encuadernado || ''}">${book.encuadernado || ''}</td>
                        <td title="${book.observaciones || ''}">${book.observaciones || ''}</td>
                        <td title="${book.ejemplares || ''}">${book.ejemplares || ''}</td>
                        <td><span class="badge-${book.estado}">${book.estado || ''}</span></td>
                        <td title="${book.isbn || ''}">${book.isbn || ''}</td>
                        <td class="action-btns">
                            <button class="btn btn-sm btn-warning" onclick="editBook('${book.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBook('${book.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
                tbody.innerHTML = html;
            });
        }

        function editBook(id) {
            const book = books.find(b => b.id === id);
            if (!book) return;
            
            document.getElementById('modalTitle').textContent = 'Editar Libro';
            document.getElementById('bookId').value = book.id;
            document.getElementById('estante').value = book.estante || '';
            document.getElementById('apellido').value = book.apellido || '';
            document.getElementById('nombre').value = book.nombre || '';
            document.getElementById('titulo').value = book.titulo || '';
            document.getElementById('volumen').value = book.volumen || '';
            document.getElementById('tomo').value = book.tomo || '';
            document.getElementById('encuadernado').value = book.encuadernado || '';
            document.getElementById('observaciones').value = book.observaciones || '';
            document.getElementById('ejemplares').value = book.ejemplares || '1';
            document.getElementById('estado').value = book.estado || 'disponible';
            document.getElementById('isbn').value = book.isbn || '';
            
            if (book.anio === 'No especifica' || !book.anio) {
                document.getElementById('noEspecificaYear').checked = true;
                document.getElementById('anio').disabled = true;
                document.getElementById('anio').value = '';
            } else {
                document.getElementById('noEspecificaYear').checked = false;
                document.getElementById('anio').disabled = false;
                document.getElementById('anio').value = book.anio;
            }
            
            document.getElementById('bookModal').classList.add('show');
        }

        async function deleteBook(id) {
            if (confirm('¬øEst√° seguro de eliminar este libro?')) {
                books = books.filter(b => b.id !== id);
                await saveToStorage();
                // Limpiar filtros y volver al inicio
                clearFilters();
                loadDashboard();
            }
        }

        function searchBooks() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = books.filter(b => 
                (b.titulo && b.titulo.toLowerCase().includes(search)) ||
                (b.apellido && b.apellido.toLowerCase().includes(search)) ||
                (b.nombre && b.nombre.toLowerCase().includes(search)) ||
                (b.isbn && b.isbn.toLowerCase().includes(search)) ||
                (b.estante && b.estante.toLowerCase().includes(search))
            );
            displayBooks(filtered);
        }

        function updateFilterEstante() {
            const select = document.getElementById('filterEstante');
            select.innerHTML = '<option value="">Todos los estantes</option>' + 
                estantes.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function filterByEstante() {
            const estante = document.getElementById('filterEstante').value;
            if (estante) {
                // Abrir panel de estante
                openEstantePanel(estante);
                // Tambi√©n filtrar la tabla
                const filtered = books.filter(b => b.estante === estante);
                displayBooks(filtered);
            } else {
                closeEstantePanel();
                displayBooks(books);
            }
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const estante = document.getElementById('filterEstante').value;
            
            // Guardar estado de filtros
            lastState.searchTerm = search;
            lastState.filterEstante = estante;
            saveLastState();
            
            // Filtrar libros de forma optimizada
            let filtered = books.filter(b => {
                // Filtro de b√∫squeda
                const matchesSearch = !search || 
                    (b.titulo && b.titulo.toLowerCase().includes(search)) ||
                    (b.apellido && b.apellido.toLowerCase().includes(search)) ||
                    (b.nombre && b.nombre.toLowerCase().includes(search)) ||
                    (b.isbn && b.isbn.toLowerCase().includes(search)) ||
                    (b.estante && b.estante.toLowerCase().includes(search));
                
                // Filtro de estante
                const matchesEstante = !estante || b.estante === estante;
                
                return matchesSearch && matchesEstante;
            });
            
            // Usar requestAnimationFrame para no bloquear UI
            requestAnimationFrame(() => {
                displayBooks(filtered);
            });
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterEstante').value = '';
            lastState.searchTerm = '';
            lastState.filterEstante = '';
            saveLastState();
            displayBooks(books);
        }

        function setupSearchListeners() {
            // Event listener para b√∫squeda
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        applyFilters();
                    }, 400); // Debounce de 400ms para mejor rendimiento
                });
            }
            
            // Event listener para filtro de estante - Ahora con input en lugar de change
            const filterEstante = document.getElementById('filterEstante');
            if (filterEstante) {
                filterEstante.addEventListener('input', () => {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(() => {
                        applyFilters();
                    }, 150); // Debounce m√°s r√°pido para estantes
                });
            }
            
            // Event listener para b√∫squeda dentro del panel de estante
            const estantePanelSearch = document.getElementById('estantePanelSearch');
            if (estantePanelSearch) {
                estantePanelSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const currentEstante = document.getElementById('filterEstante').value;
                    updateEstantePanelBooks(currentEstante, searchTerm);
                });
            }
        }

        // PANEL DE ESTANTE
        let currentEstantePanel = null;

        function openEstantePanel(estante) {
            currentEstantePanel = estante;
            const panel = document.getElementById('estantePanel');
            document.getElementById('estantePanelTitle').textContent = `üìö Estante: ${estante}`;
            document.getElementById('estantePanelSearch').value = '';
            panel.classList.add('active');
            updateEstantePanelBooks(estante, '');
        }

        function closeEstantePanel() {
            const panel = document.getElementById('estantePanel');
            panel.classList.remove('active');
            currentEstantePanel = null;
            document.getElementById('filterEstante').value = '';
        }

        function updateEstantePanelBooks(estante, searchTerm = '') {
            const booksContainer = document.getElementById('estantePanelBooks');
            const estanteBooksFilter = books.filter(b => b.estante === estante);
            
            // Filtrar por t√©rmino de b√∫squeda
            let filteredBooks = estanteBooksFilter;
            if (searchTerm) {
                filteredBooks = estanteBooksFilter.filter(b =>
                    (b.titulo && b.titulo.toLowerCase().includes(searchTerm)) ||
                    (b.apellido && b.apellido.toLowerCase().includes(searchTerm)) ||
                    (b.nombre && b.nombre.toLowerCase().includes(searchTerm)) ||
                    (b.isbn && b.isbn.toLowerCase().includes(searchTerm))
                );
            }

            // Actualizar estad√≠sticas
            const disponibles = estanteBooksFilter.filter(b => b.estado === 'disponible').length;
            document.getElementById('estanteTotalBooks').textContent = estanteBooksFilter.length;
            document.getElementById('estanteAvailableBooks').textContent = disponibles;

            // Renderizar libros
            if (filteredBooks.length === 0) {
                booksContainer.innerHTML = `
                    <div class="estante-empty">
                        <p>${searchTerm ? '‚ùå No se encontraron libros' : 'üì≠ Sin libros en este estante'}</p>
                    </div>
                `;
            } else {
                booksContainer.innerHTML = filteredBooks.map(book => `
                    <div class="estante-book-item">
                        <h4>${book.titulo}</h4>
                        <p><strong>Autor:</strong> ${book.apellido}, ${book.nombre}</p>
                        <p><strong>Ord:</strong> ${book.ordinal} | <strong>A√±o:</strong> ${book.anio} | <span class="badge-${book.estado}">${book.estado}</span></p>
                        ${book.isbn ? `<p><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
                        ${book.observaciones ? `<p><strong>Obs:</strong> ${book.observaciones}</p>` : ''}
                        <div class="estante-book-actions">
                            <button class="btn btn-sm btn-warning" onclick="editBookFromPanel('${book.id}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBookFromPanel('${book.id}')">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function editBookFromPanel(id) {
            editBook(id);
            // El modal se abrir√° y el panel permanecer√° visible
        }

        async function deleteBookFromPanel(id) {
            if (confirm('¬øEst√° seguro de eliminar este libro?')) {
                books = books.filter(b => b.id !== id);
                await saveToStorage();
                
                // Actualizar el panel
                const currentEstante = document.getElementById('filterEstante').value;
                if (currentEstante) {
                    updateEstantePanelBooks(currentEstante);
                    const filtered = books.filter(b => b.estante === currentEstante);
                    displayBooks(filtered);
                }
                
                loadDashboard();
            }
        }

        function displayBooks(bookList) {
            const tbody = document.getElementById('booksTableBody');
            const fragment = document.createDocumentFragment();
            
            bookList.forEach(book => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td title="${book.ordinal || ''}">${book.ordinal || ''}</td><td title="${book.estante || ''}">${book.estante || ''}</td><td title="${book.apellido || ''}">${book.apellido || ''}</td><td title="${book.nombre || ''}">${book.nombre || ''}</td><td title="${book.titulo || ''}">${book.titulo || ''}</td><td title="${book.volumen || ''}">${book.volumen || ''}</td><td title="${book.tomo || ''}">${book.tomo || ''}</td><td title="${book.anio || ''}">${book.anio || ''}</td><td title="${book.encuadernado || ''}">${book.encuadernado || ''}</td><td title="${book.observaciones || ''}">${book.observaciones || ''}</td><td title="${book.ejemplares || ''}">${book.ejemplares || ''}</td><td><span class="badge-${book.estado}">${book.estado || ''}</span></td><td title="${book.isbn || ''}">${book.isbn || ''}</td><td class="action-btns"><button class="btn btn-sm btn-warning" onclick="editBook('${book.id}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="deleteBook('${book.id}')">üóëÔ∏è</button></td>`;
                fragment.appendChild(tr);
            });
            
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        // EXPORTAR EXCEL
        function exportToExcel() {
            const data = books.map(b => ({
                'Ordinal': b.ordinal || '',
                'Estante': b.estante || '',
                'Apellido': b.apellido || '',
                'Nombre': b.nombre || '',
                'T√≠tulo': b.titulo || '',
                'Volumen': b.volumen || '',
                'Tomo': b.tomo || '',
                'A√±o': b.anio || '',
                'Encuadernado': b.encuadernado || '',
                'Observaciones': b.observaciones || '',
                'Ejemplares': b.ejemplares || '',
                'Estado': b.estado || '',
                'ISBN': b.isbn || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Libros');
            XLSX.writeFile(wb, 'biblioteca_libros.xlsx', { bookType: 'xlsx', type: 'binary', compression: true });
        }

        // IMPORTAR EXCEL
        async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üìÅ Archivo seleccionado:', file.name);

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellText: false,
                        cellDates: false,
                        raw: true
                    });
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                        raw: true,
                        defval: '',
                        blankrows: true,
                        header: 1
                    });

                    if (jsonData.length === 0) {
                        alert('‚ö†Ô∏è El archivo Excel est√° vac√≠o');
                        return;
                    }

                    // Obtener encabezados (primera fila)
                    const headers = jsonData[0];
                    console.log('üìã Encabezados detectados:', headers);

                    // Funci√≥n para encontrar √≠ndice de columna
                    const findColumnIndex = (possibleNames) => {
                        for (let name of possibleNames) {
                            const index = headers.findIndex(h => 
                                h && h.toString().toLowerCase().trim() === name.toLowerCase()
                            );
                            if (index !== -1) return index;
                        }
                        return -1;
                    };

                    // Mapear √≠ndices de columnas
                    const columnMap = {
                        ordinal: findColumnIndex(['ordinal', 'numero', 'n√∫mero', 'nro', 'n¬∞']),
                        estante: findColumnIndex(['estante', 'ubicacion', 'ubicaci√≥n']),
                        apellido: findColumnIndex(['apellido', 'apellidos']),
                        nombre: findColumnIndex(['nombre', 'nombres']),
                        titulo: findColumnIndex(['t√≠tulo', 'titulo', 'title']),
                        volumen: findColumnIndex(['volumen', 'vol', 'vol.']),
                        tomo: findColumnIndex(['tomo', 't', 'tom']),
                        anio: findColumnIndex(['a√±o', 'ano', 'anio', 'fecha', 'year']),
                        encuadernado: findColumnIndex(['encuadernado', 'encuadernaci√≥n', 'tipo']),
                        observaciones: findColumnIndex(['observaciones', 'observaci√≥n', 'obs', 'notas', 'nota']),
                        ejemplares: findColumnIndex(['ejemplares', 'cantidad', 'cant', 'cant.']),
                        estado: findColumnIndex(['estado', 'status', 'situaci√≥n', 'situacion']),
                        isbn: findColumnIndex(['isbn', 'codigo', 'c√≥digo', 'cod'])
                    };

                    console.log('üó∫Ô∏è Mapa de columnas:', columnMap);

                    let importCount = 0;
                    let errorCount = 0;
                    let emptyRowCount = 0;

                    // Procesar datos (desde la segunda fila)
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // Saltar filas completamente vac√≠as
                        if (!row || row.every(cell => !cell || cell.toString().trim() === '')) {
                            emptyRowCount++;
                            continue;
                        }

                        // Funci√≥n helper para obtener valor de celda
                        const getValue = (colIndex) => {
                            if (colIndex === -1 || !row[colIndex]) return '';
                            return row[colIndex].toString().trim();
                        };

                        const titulo = getValue(columnMap.titulo);
                        
                        // Solo validar que tenga t√≠tulo (no vac√≠o)
                        if (!titulo) {
                            errorCount++;
                            continue;
                        }

                        const book = {
                            id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
                            ordinal: getValue(columnMap.ordinal) || (importCount + 1).toString(),
                            estante: getValue(columnMap.estante),
                            apellido: getValue(columnMap.apellido),
                            nombre: getValue(columnMap.nombre),
                            titulo: titulo,
                            volumen: getValue(columnMap.volumen),
                            tomo: getValue(columnMap.tomo),
                            anio: getValue(columnMap.anio) || 'No especifica',
                            encuadernado: getValue(columnMap.encuadernado),
                            observaciones: getValue(columnMap.observaciones),
                            ejemplares: getValue(columnMap.ejemplares) || '1',
                            estado: (getValue(columnMap.estado) || 'disponible').toLowerCase(),
                            isbn: getValue(columnMap.isbn)
                        };

                        // Normalizar estado
                        if (!['disponible', 'prestado', 'donado'].includes(book.estado)) {
                            book.estado = 'disponible';
                        }

                        books.push(book);
                        
                        // Agregar estante a la lista si no existe y no est√° vac√≠o
                        if (book.estante && !estantes.includes(book.estante)) {
                            estantes.push(book.estante);
                        }
                        
                        importCount++;
                    }

                    await saveToStorage();
                    // Limpiar filtros y volver al inicio despu√©s de importar
                    clearFilters();
                    loadDashboard();

                    let message = `‚úÖ ¬°Importaci√≥n exitosa!\n\n`;
                    message += `üìö ${importCount} libros importados\n`;
                    if (errorCount > 0) {
                        message += `‚ö†Ô∏è ${errorCount} filas omitidas (sin t√≠tulo)\n`;
                    }
                    if (emptyRowCount > 0) {
                        message += `‚ÑπÔ∏è ${emptyRowCount} filas vac√≠as omitidas`;
                    }
                    alert(message);
                    
                    event.target.value = ''; // Limpiar input
                } catch (error) {
                    alert('‚ùå Error al importar el archivo.\n\nDetalles: ' + error.message);
                    console.error('Error de importaci√≥n completo:', error);
                }
            };
            
            reader.onerror = (error) => {
                alert('‚ùå Error al leer el archivo');
                console.error('Error de lectura:', error);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // NUEVO USUARIO
        document.getElementById('newUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newUserRole').value,
                lastActivity: new Date().toISOString(),
                active: true
            };
            users.push(user);
            await saveToStorage();
            alert('Usuario creado exitosamente');
            document.getElementById('newUserForm').reset();
        });

        // BALANCE
        let currentBalanceEstante = null;
        let currentBalanceBooks = [];

        function loadBalanceProgress() {
            // Cargar estantes en el selector
            const select = document.getElementById('balanceEstanteSelect');
            select.innerHTML = '<option value="">-- Seleccione un estante --</option>' + 
                estantes.sort().map(e => `<option value="${e}">${e}</option>`).join('');
            
            // Mostrar progreso general si hay balance iniciado
            if (balanceData.estantes && balanceData.estantes.length > 0) {
                showGeneralBalanceProgress();
            }
        }

        function startEstanteBalance() {
            const estante = document.getElementById('balanceEstanteSelect').value;
            if (!estante) {
                alert('‚ö†Ô∏è Por favor seleccione un estante');
                return;
            }

            currentBalanceEstante = estante;
            currentBalanceBooks = books.filter(b => b.estante === estante).map(b => ({
                ...b,
                balanceStatus: 'pending' // pending, found, missing
            }));

            if (currentBalanceBooks.length === 0) {
                alert('‚ö†Ô∏è No hay libros en este estante');
                return;
            }

            // Inicializar balance data si no existe
            if (!balanceData.estantes) {
                balanceData.estantes = [];
            }

            // Verificar si el estante ya fue auditado
            const existingBalance = balanceData.estantes.find(e => e.estante === estante);
            if (existingBalance) {
                if (confirm(`El estante ${estante} ya fue auditado. ¬øDesea volver a auditarlo?`)) {
                    currentBalanceBooks = existingBalance.books;
                } else {
                    return;
                }
            }

            document.getElementById('balanceChecklistContainer').style.display = 'block';
            document.getElementById('currentEstanteName').textContent = `Auditando Estante: ${estante}`;
            updateBalanceChecklist();
        }

        function updateBalanceChecklist() {
            const container = document.getElementById('balanceBooksList');
            const total = currentBalanceBooks.length;
            const found = currentBalanceBooks.filter(b => b.balanceStatus === 'found').length;
            const missing = currentBalanceBooks.filter(b => b.balanceStatus === 'missing').length;
            const pending = currentBalanceBooks.filter(b => b.balanceStatus === 'pending').length;
            
            document.getElementById('totalBooksBalance').textContent = total;
            document.getElementById('foundBooksBalance').textContent = found;
            document.getElementById('missingBooksBalance').textContent = missing;
            document.getElementById('pendingBooksBalance').textContent = pending;

            const progress = total > 0 ? Math.round(((found + missing) / total) * 100) : 0;
            document.getElementById('estanteProgress').style.width = progress + '%';
            document.getElementById('estanteProgress').textContent = progress + '%';

            container.innerHTML = currentBalanceBooks.map((book, index) => `
                <div class="checklist-book-item ${book.balanceStatus === 'found' ? 'found' : book.balanceStatus === 'missing' ? 'missing' : ''}">
                    <div class="book-info">
                        <h4>${book.titulo}</h4>
                        <p><strong>Autor:</strong> ${book.apellido}, ${book.nombre}</p>
                        <p><strong>Ordinal:</strong> ${book.ordinal} | <strong>A√±o:</strong> ${book.anio} | <strong>ISBN:</strong> ${book.isbn || 'N/A'}</p>
                        ${book.observaciones ? `<p><strong>Obs:</strong> ${book.observaciones}</p>` : ''}
                    </div>
                    <div class="book-actions">
                        <button class="btn btn-success btn-sm" onclick="markBookStatus(${index}, 'found')" 
                                ${book.balanceStatus === 'found' ? 'disabled' : ''}>
                            ‚úì Encontrado
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="markBookStatus(${index}, 'missing')"
                                ${book.balanceStatus === 'missing' ? 'disabled' : ''}>
                            ‚úó Faltante
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function markBookStatus(index, status) {
            currentBalanceBooks[index].balanceStatus = status;
            updateBalanceChecklist();
        }

        async function finishEstanteBalance() {
            const pending = currentBalanceBooks.filter(b => b.balanceStatus === 'pending').length;
            
            if (pending > 0) {
                if (!confirm(`‚ö†Ô∏è Hay ${pending} libros sin revisar. ¬øDesea finalizar de todos modos?`)) {
                    return;
                }
            }

            // Guardar resultado del estante
            const estanteBalance = {
                estante: currentBalanceEstante,
                fecha: new Date().toISOString(),
                books: currentBalanceBooks,
                total: currentBalanceBooks.length,
                encontrados: currentBalanceBooks.filter(b => b.balanceStatus === 'found').length,
                faltantes: currentBalanceBooks.filter(b => b.balanceStatus === 'missing').length
            };

            // Actualizar o agregar balance del estante
            const existingIndex = balanceData.estantes.findIndex(e => e.estante === currentBalanceEstante);
            if (existingIndex >= 0) {
                balanceData.estantes[existingIndex] = estanteBalance;
            } else {
                balanceData.estantes.push(estanteBalance);
            }

            await saveToStorage();
            
            alert(`‚úÖ Balance del estante ${currentBalanceEstante} guardado exitosamente!\n\n` +
                  `üìö Total: ${estanteBalance.total}\n` +
                  `‚úì Encontrados: ${estanteBalance.encontrados}\n` +
                  `‚úó Faltantes: ${estanteBalance.faltantes}`);

            // Limpiar y volver al inicio
            currentBalanceEstante = null;
            currentBalanceBooks = [];
            document.getElementById('balanceChecklistContainer').style.display = 'none';
            document.getElementById('balanceEstanteSelect').value = '';
            
            showGeneralBalanceProgress();
        }

        function cancelEstanteBalance() {
            if (confirm('¬øEst√° seguro de cancelar la auditor√≠a? Se perder√°n los cambios no guardados.')) {
                currentBalanceEstante = null;
                currentBalanceBooks = [];
                document.getElementById('balanceChecklistContainer').style.display = 'none';
                document.getElementById('balanceEstanteSelect').value = '';
            }
        }

        function showGeneralBalanceProgress() {
            const container = document.getElementById('balanceProgressContainer');
            container.style.display = 'block';

            const totalEstantes = estantes.length;
            const completedEstantes = balanceData.estantes ? balanceData.estantes.length : 0;
            const totalLibros = books.length;
            const librosRevisados = balanceData.estantes ? 
                balanceData.estantes.reduce((sum, e) => sum + e.total, 0) : 0;
            const librosEncontrados = balanceData.estantes ? 
                balanceData.estantes.reduce((sum, e) => sum + e.encontrados, 0) : 0;
            const librosFaltantes = balanceData.estantes ? 
                balanceData.estantes.reduce((sum, e) => sum + e.faltantes, 0) : 0;

            document.getElementById('generalBalanceStats').innerHTML = `
                <div class="balance-summary">
                    <div class="summary-card">
                        <h3>${completedEstantes}/${totalEstantes}</h3>
                        <p>Estantes Completados</p>
                    </div>
                    <div class="summary-card">
                        <h3>${librosRevisados}/${totalLibros}</h3>
                        <p>Libros Revisados</p>
                    </div>
                    <div class="summary-card success">
                        <h3>${librosEncontrados}</h3>
                        <p>Encontrados</p>
                    </div>
                    <div class="summary-card danger">
                        <h3>${librosFaltantes}</h3>
                        <p>Faltantes</p>
                    </div>
                </div>
            `;

            const estantesList = balanceData.estantes ? balanceData.estantes.map(e => `
                <div class="checklist-book-item found" style="margin-bottom: 10px;">
                    <div class="book-info">
                        <h4>Estante ${e.estante}</h4>
                        <p>Total: ${e.total} | Encontrados: ${e.encontrados} | Faltantes: ${e.faltantes}</p>
                        <p style="font-size: 12px; color: #666;">Fecha: ${new Date(e.fecha).toLocaleString()}</p>
                    </div>
                    <button class="btn btn-info btn-sm" onclick="viewEstanteBalanceDetail('${e.estante}')">Ver Detalle</button>
                </div>
            `).join('') : '<p>No hay estantes auditados a√∫n.</p>';

            document.getElementById('estantesCompletedList').innerHTML = `
                <h4 style="margin: 20px 0 10px 0;">Estantes Auditados:</h4>
                ${estantesList}
            `;
        }

        function viewEstanteBalanceDetail(estante) {
            const balance = balanceData.estantes.find(e => e.estante === estante);
            if (!balance) return;

            const faltantes = balance.books.filter(b => b.balanceStatus === 'missing');
            const encontrados = balance.books.filter(b => b.balanceStatus === 'found');

            let message = `üìä DETALLE ESTANTE ${estante}\n\n`;
            message += `Total: ${balance.total}\n`;
            message += `‚úì Encontrados: ${encontrados.length}\n`;
            message += `‚úó Faltantes: ${faltantes.length}\n\n`;
            
            if (faltantes.length > 0) {
                message += `LIBROS FALTANTES:\n`;
                faltantes.forEach(b => {
                    message += `- ${b.titulo} (${b.apellido}, ${b.nombre})\n`;
                });
            }

            alert(message);
        }

        function generateFinalBalanceReport() {
            if (!balanceData.estantes || balanceData.estantes.length === 0) {
                alert('‚ö†Ô∏è No hay datos de balance para generar reporte');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('REPORTE FINAL DE BALANCE', 20, 20);
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleString()}`, 20, 30);
            
            let y = 45;
            
            balanceData.estantes.forEach(e => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(14);
                doc.text(`Estante ${e.estante}`, 20, y);
                y += 7;
                
                doc.setFontSize(10);
                doc.text(`Total: ${e.total} | Encontrados: ${e.encontrados} | Faltantes: ${e.faltantes}`, 20, y);
                y += 10;
                
                const faltantes = e.books.filter(b => b.balanceStatus === 'missing');
                if (faltantes.length > 0) {
                    doc.text('Libros Faltantes:', 25, y);
                    y += 5;
                    faltantes.forEach(b => {
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.setFontSize(9);
                        doc.text(`- ${b.titulo} (${b.apellido}, ${b.nombre})`, 30, y);
                        y += 5;
                    });
                }
                y += 5;
            });

            doc.save('balance_final_biblioteca.pdf');
            alert('‚úÖ Reporte generado exitosamente');
        }

        async function resetBalance() {
            if (confirm('‚ö†Ô∏è ¬øEst√° seguro de reiniciar el balance completo? Se perder√°n todos los datos.')) {
                balanceData = { estantes: [] };
                await saveToStorage();
                document.getElementById('balanceProgressContainer').style.display = 'none';
                alert('‚úÖ Balance reiniciado');
                loadBalanceProgress();
            }
        }

        // REPORTE ESTANTES
        function loadEstanteSelect() {
            const select = document.getElementById('estanteSelect');
            select.innerHTML = '<option value="">Seleccionar estante</option>' + 
                estantes.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function loadEstanteReport() {
            const estante = document.getElementById('estanteSelect').value;
            if (!estante) return;

            const librosEstante = books.filter(b => b.estante === estante);
            const html = `
                <h3>Estante: ${estante}</h3>
                <p>Total de libros: ${librosEstante.length}</p>
                <table>
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>Autor</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${librosEstante.map(b => `
                            <tr>
                                <td>${b.titulo}</td>
                                <td>${b.autor}</td>
                                <td>${b.estado}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('estanteReportContent').innerHTML = html;
        }

        function printEstanteReport(general) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            if (general) {
                doc.setFontSize(16);
                doc.text('Reporte General de Estantes', 20, 20);
                
                let y = 40;
                estantes.forEach(e => {
                    const librosEstante = books.filter(b => b.estante === e);
                    doc.setFontSize(12);
                    doc.text(`Estante ${e}: ${librosEstante.length} libros`, 20, y);
                    y += 10;
                });
            } else {
                const estante = document.getElementById('estanteSelect').value;
                const librosEstante = books.filter(b => b.estante === estante);
                
                doc.setFontSize(16);
                doc.text(`Reporte Estante ${estante}`, 20, 20);
                
                let y = 40;
                librosEstante.forEach(b => {
                    doc.setFontSize(10);
                    doc.text(`${b.titulo} - ${b.autor}`, 20, y);
                    y += 7;
                });
            }

            doc.save('reporte_estantes.pdf');
        }

        // INICIAR APP
        init();
    </script>
</body>
</html>
